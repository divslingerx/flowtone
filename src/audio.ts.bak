/**
 * @deprecated This file is kept for reference but is not actively used.
 * Audio functionality has been moved to src/store/audioEngine.ts
 */
import { ToneComponentKey } from "./nodes/types";
import * as Tone from "tone";

const context = new AudioContext();
const nodes = new Map<string, AudioNode | Tone.ToneAudioNode>();

const osc = context.createOscillator();
osc.frequency.value = 220;
osc.type = "square";
osc.start();

const amp = context.createGain();
amp.gain.value = 0.5;

const out = context.destination;

nodes.set("a", osc);
nodes.set("b", amp);
nodes.set("c", out);

export function updateAudioNode(id: string, data: Record<string, unknown>) {
  const node = nodes.get(id);
  if (!node) return;

  for (const [key, val] of Object.entries(data)) {
    const nodeAny = node as unknown as Record<string, unknown>;
    const param = nodeAny[key];
    if (param instanceof AudioParam) {
      param.value = val as number;
    } else {
      nodeAny[key] = val;
    }
  }
}

export function removeAudioNode(id: string) {
  const node = nodes.get(id);
  if (!node) return;

  if ("disconnect" in node) {
    node.disconnect();
  }
  if ("stop" in node && typeof node.stop === "function") {
    node.stop();
  }

  nodes.delete(id);
}

export function connect(sourceId: string, targetId: string) {
  const source = nodes.get(sourceId);
  const target = nodes.get(targetId);
  if (!source || !target) return;

  if ("connect" in source && typeof source.connect === "function") {
    source.connect(target as AudioNode);
  }
}

export function isRunning() {
  return context.state === "running";
}

export function toggleAudio() {
  return isRunning() ? context.suspend() : context.resume();
}

export function createAudioNode(
  id: string,
  type: ToneComponentKey,
  data: Partial<Tone.OmniOscillatorOptions>
) {
  switch (type) {
    case "OmniOscillator": {
      const node = new Tone.OmniOscillator(data);
      node.start();
      nodes.set(id, node);
      break;
    }
    case "Gain": {
      const node = context.createGain();
      nodes.set(id, node);
      break;
    }
  }
}
